pipeline {
  agent any
  stages {
    stage('Clean') {
      steps {
        sh 'git clean -ffdx'
        sh 'Rscript -e \"install.packages(\'devtools\')\"'
      }
    }
    stage('Test') {
      steps {
        sh 'Rscript -e \"devtools::install_deps(\'./fcrn\')\"'
        sh 'R CMD INSTALL --no-multiarch --with-keep.source fcrn'
        sh 'Rscript -e \"covr::to_cobertura(covr::package_coverage(\'./fcrn\', quiet = F))\"'
      }
    }
    stage('Build') {
      steps {
        sh 'make all'
      }
    }
    stage('Report') {
      steps {
        archiveArtifacts artifacts: 'output.pdf', onlyIfSuccessful: true
        cobertura coberturaReportFile: 'cobertura.xml', failUnhealthy: false, failUnstable: false, maxNumberOfBuilds: 0, onlyStable: false, sourceEncoding: 'ASCII', zoomCoverageChart: false
      }
    }
  }
}
