pipeline {
  agent any
  stages {
    stage('Clean') {
      steps { sh 'git clean -ffdx' }
    }
    stage('Test') {
      steps {
        sh 'R CMD INSTALL covr'
        sh 'Rscript -e \"covr::to_cobertura(covr::package_coverage(\'./fcrn\', quiet = F))\"'
      }
    }
    stage('Build') {
      steps {
        sh 'make all'
      }
    }
    stage('Report') {
      steps {
        archiveArtifacts artifacts: 'output.pdf', onlyIfSuccessful: true
        archiveArtifacts artifacts: 'README.pdf', onlyIfSuccessful: true
        archiveArtifacts artifacts: 'README.docx', onlyIfSuccessful: true
        step([
          $class: 'CoberturaPublisher',
          autoUpdateHealth: true,
          autoUpdateStability: true,
          coberturaReportFile: 'cobertura.xml',
          failNoReports: true,
          failUnhealthy: true,
          failUnstable: true,
          sourceEncoding: 'UTF_8',
          zoomCoverageChart: true])
      }
    }
  }
}
