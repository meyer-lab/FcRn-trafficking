---
title: "FcRn trafficking analysis"
output: pdf_document
---

```{r, message=TRUE, include=FALSE}
library(rstan)
library(magrittr)
parrs <- c("Vp", "Qu", "Vin", "actual_sortF_wt",
           "actual_sortF_dhs", "actual_sortF_ls", "sortF_yte",
           "actual_release_ls", "releaseF_yte")
```

This data was then fit to the PK studies data using `stan`. Rather than a local sensitivity analysis, I've employed Markov Chain Monte Carlo, which is a Bayesian approach that fully samples the model posterior. While computationally much more expensive, this provides the most rigorous confidence intervals for each parameter. I've included the overview output below which most importantly shows that the fitting process worked and came to convergence (e.g. Rhat < 1.1).

```{r}
load('model/diff_samples.rds')
print(fit, pars = parrs, probs = c(0.025, 0.975))
```

Looking at the posterior confidence intervals:

```{r, fig.height=4, fig.width=5}
stan_plot(fit, pars = parrs)
```


These results provide a few observations: Changing the pH 5.8 affinity from 111 nM to 55 nM only corresponds to a small increase in IgG recycling. This is in contrast to the WT to DHS change of 550 nM to 111 nM where sorting is greatly affected.

It makes sense that further affinity enrichment in the endosome should have diminishing returns with respect to the sorting fraction since a greater fraction of IgG becomes bound. Looking at the `sortF` parameters, this suggests the effective concentration of endosomal IgG is around 500 nM. Interpreting this as the actual endosomal concentration, though, would require assuming that the endosomal compartment comes to equilibrium.

While we don't have an exact estimate for the amount of LS IgG recaptured, the 95% confidence bound is that it's greater than 30% (note: 1 - releaseF).

Here are the results for the humanized model (Scarlett). The results are overall very similar, with some subtle shifts in the recapture amount (releaseF) and sorting. These subtle changes are sufficient to explain the differences between the two models.

```{r}
load('model/humanized_samples.rds')
print(fit, pars = parrs, probs = c(0.025, 0.975))
```

Looking at the posterior confidence intervals:

```{r, fig.height=4, fig.width=5}
stan_plot(fit, pars = parrs)
```

Lastly, I've plotted the predicted half-life for a particular sorting and release fraction below, taking into account the uncertainty of the previous fitting. The plot shows the prediction's 50% and 80% prediction intervals.

```{r}
load('predictions.rds')
output %<>% dplyr::mutate(halfl = halfl/24) %>%
  dplyr::group_by(sortF, releaseF) %>%
  dplyr::summarize(lwra = quantile(halfl, 0.25),
                   upra = quantile(halfl, 0.75),
                   lwr = quantile(halfl, 0.1),
                   upr = quantile(halfl, 0.9)) %>%
  dplyr::ungroup()


ggplot2::ggplot(output, ggplot2::aes(x = sortF, color = as.factor(releaseF), group = releaseF)) +
  ggplot2::geom_ribbon(ggplot2::aes(ymin = lwr, ymax = upr, fill = as.factor(releaseF)),
                       linetype = "blank",
                       alpha = 0.3) +
  ggplot2::geom_ribbon(ggplot2::aes(ymin = lwra, ymax = upra, fill = as.factor(releaseF)),
                       linetype = "blank",
                       alpha = 0.6) +
  ggplot2::theme_minimal() +
  ggplot2::scale_x_continuous(breaks=seq(0, 1, 0.1)) +
  ggplot2::xlab("Sorting fraction") +
  ggplot2::ylab("log10(Half life in days)") + 
  ggplot2::scale_y_log10()
```

What this shows most clearly is that both parameters matter. As soon as you've optimized the endosomal sorting, surface release becomes a much more critical factor.
